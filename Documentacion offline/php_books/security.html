<div id="security" class="book"><hr>
  <h1 class="title">Seguridad</h1>
  



 <div id="security.intro" class="chapter"><hr>
  <h1 class="title">Introducción</h1>

  <p class="simpara">
   PHP es un potente lenguaje, y su intérprete, bien como módulo
   del servidor web o bien como binario <abbr title="Common Gateway Interface">CGI</abbr>,
   puede acceder a ficheros, ejecutar comandos o abrir conexiones de
   red desde el servidor. Estas propiedades hacen que, por omisión,
   sea inseguro todo lo que se ejecute en un servidor web.
   PHP está diseñado específicamente para ser un lenguaje más seguro
   para escribir aplicaciones <abbr title="Common Gateway Interface">CGI</abbr> que Perl o C.
   Partiendo de un correcto ajuste de opciones de configuración para tiempo de ejecución
   y en tiempo de compilación, y el uso de prácticas de programación
   apropiadas, pueden proporcionarle la combinación de libertad y de
   seguridad que necesita.
  </p>
  <p class="simpara">
   Dado que hay muchas vías para ejecutar PHP, existen muchas opciones de
   configuración para controlar su comportamiento. Al haber una extensa selección
   de opciones se garantiza poder usar PHP para un gran número de propósitos, pero a la
   vez significa que existen combinaciones que conllevan una configuración
   menos segura.
  </p>
  <p class="simpara">
   La flexibilidad de configuración de PHP rivaliza igualmente con la
   flexibilidad de su código. PHP puede ser usado para construir completas
   aplicaciones de servidor, con toda la potencia de un usuario de consola,
   o se puede usar sólo desde el lado del servidor implicando un menor
   riesgo dentro de un entorno controlado. El cómo construir ese entorno, y cómo
   de seguro es, depende del desarrollador PHP.
  </p>
  <p class="simpara">
   Este capítulo comienza con algunos consejos generales de seguridad, explica
   las diferentes combinaciones de opciones de configuración y las situaciones
   en que pueden ser útiles, y describe diferentes consideraciones relacionadas
   con la programación de acuerdo a diferentes niveles de seguridad.
  </p>
 </div>

<hr>




  



  <div id="security.general" class="chapter"><hr>
   <h1 class="title">Consideraciones generales</h1>

   <p class="simpara">
    Un sistema completamente seguro es prácticamente un
    imposible, de modo que el enfoque usado con mayor frecuencia en la
    profesión de seguridad es uno que busque el balance
    adecuado entre riesgo y funcionalidad. Si cada variable enviada
    por un usuario requiriera de dos formas de validación
    biométrica (como rastreo de retinas y análisis
    dactilar), usted contaría con un nivel extremadamente alto
    de confiabilidad. También implicaría que llenar los
    datos de un formulario razonablemente complejo podría tomar
    media hora, cosa que podría incentivar a los usuarios a
    buscar métodos para esquivar los mecanismos de seguridad.
   </p>
   <p class="simpara">
    La mejor seguridad con frecuencia es lo suficientemente razonable
    como para suplir los requerimientos dados sin prevenir que el
    usuario realice su labor de forma natural, y sin sobrecargar al
    autor del código con una complejidad excesiva. De hecho,
    algunos ataques de seguridad son simples recursos que aprovechan
    las vulnerabilidades de este tipo de seguridad sobrecargada, que
    tiende a erosionarse con el tiempo.
   </p>
   <p class="simpara">
    Una frase que vale la pena recordar: Un sistema es apenas tan
    bueno como el eslabón más débil de una
    cadena. Si todas las transacciones son registradas copiosamente
    basándose en la fecha/hora, ubicación, tipo de
    transacción, etc. pero la verificación del usuario
    se realiza únicamente mediante una cookie sencilla, la
    validez de atar a los usuarios al registro de transacciones es
    mermada severamente.
   </p>
   <p class="simpara">
    Cuando realice pruebas, tenga en mente que no será capaz de
    probar todas las diferentes posibilidades, incluso para las
    páginas más simples. Los datos de entrada que usted
    puede esperar en sus aplicaciones no necesariamente tendrán
    relación alguna con el tipo de información que
    podría ingresar un empleado disgustado, un cracker con
    meses de tiempo entre sus manos, o un gato doméstico
    caminando sobre el teclado. Es por esto que es mejor observar el
    código desde una perspectiva lógica, para determinar
    en dónde podrían introducirse datos inesperados, y
    luego hacer un seguimiento de cómo esta información
    es modificada, reducida o amplificada.
   </p>
   <p class="simpara">
    Internet está repleto de personas que tratan de crearse
    fama al romper la seguridad de su código, bloquear su
    sitio, publicar contenido inapropiado, y por lo demás
    haciendo que sus días sean más interesantes. No
    importa si usted administra un sitio pequeño o grande,
    usted es un objetivo por el simple hecho de estar en línea,
    por tener un servidor al cual es posible conectarse. Muchas
    aplicaciones de cracking no hacen distinciones por tamaños,
    simplemente recorren bloques masivos de direcciones IP en busca de
    víctimas. Trate de no convertirse en una.
   </p>
  </div>

<hr>




  




  <div id="security.cgi-bin" class="chapter"><hr>
   <h1 class="title">Instalado como CGI binario</h1>
<h2>Tabla de contenidos</h2><ul class="chunklist chunklist_chapter"><li><a href="#security.cgi-bin.attacks">Ataques posibles</a></li><li><a href="#security.cgi-bin.default">Caso 1: Ficheros públicos servidos solamente</a></li><li><a href="#security.cgi-bin.force-redirect">Caso 2: utilizando cgi.force_redirect</a></li><li><a href="#security.cgi-bin.doc-root">Caso 3: Configurando doc_root o user_dir</a></li><li><a href="#security.cgi-bin.shell">Caso 4: El analizador de PHP fuera del árbol de la web</a></li></ul>


   <div id="security.cgi-bin.attacks" class="sect1"><hr>
    <h2 class="title">Ataques posibles</h2>
    <p class="simpara">
     Usar PHP como un binario <abbr title="Common Gateway Interface">CGI</abbr> es una opción para
     configuraciones que por alguna razón no desean integrar PHP como un
     módulo dentro del software de servidor (como Apache), o usarán PHP con
     diferentes tipos de envoltorios <abbr title="Common Gateway Interface">CGI</abbr> para crear entornos
     seguros <strong class="command">chroot</strong> y <strong class="command">setuid</strong> para scripts.
     Esta configuración usualmente involucra la instalación del binario
     ejecutable de <strong class="command">php</strong> en el directorio <var class="filename">cgi-bin</var>
     del servidor web. La recomendación <a href="http://www.cert.org/advisories/CA-1996-11.html" class="link external">» CA-96.11</a> del CERT recomienda
     que está en contra de colocar cualquiera de los intérpretes dentro de <var class="filename">cgi-bin</var>.
     Aún si el binario de <strong class="command">php</strong> puede ser usado como un intérprete independiente, PHP está diseñado
     para prevenir los ataques que esta configuración hace posible:
    </p>
    <ul class="itemizedlist">
     <li class="listitem">
      <span class="simpara">
       Accediendo a los ficheros del sistema: <var class="filename">http://mi.servidor/cgi-bin/php?/etc/passwd</var>
      </span>
      <span class="simpara">
       La consulta de información en una URL después del signo de interrogación (<code class="literal">?</code>)  es
       pasado como argumento de la línea de comandos al intérprete por la interfaz
       del CGI. Usualmente los intérpretes abren y ejecutan el fichero
       especificado como el primer argumento en la línea de comandos.
      </span>
      <span class="simpara">
       Cuando es invocado como un binario de CGI, <strong class="command">php</strong> se niega a interpretar los
       argumentos de línea de comandos.
      </span>
     </li>
     <li class="listitem">
      <span class="simpara">
       Accediendo a cualquier documento web en el servidor: <var class="filename">http://mi.servidor/cgi-bin/php/directorio/secreto/doc.html</var>
      </span>
      <span class="simpara">
       Parte de la ruta de información de la URL después del nombre del binario de PHP,
       <var class="filename">/directorio/secreto/doc.html</var> es
       convencionalmente utilizado para especificar el nombre del fichero
       a ser abierto e interpretado por el programa <abbr title="Common Gateway Interface">CGI</abbr>.
       Usualmente las directivas de configuración de algunos servidores web (Apache:
       <code class="literal">Action</code>) son utilizados para redirigir peticiones a los documentos como
       <var class="filename">http://mi.servidor/directorio/secreto/script.php</var> al
       intérprete de PHP.  Con esta configuración, el servidor web revisa primero
       los permisos de acceso a los directorios <var class="filename">/directorio/secreto</var>, y después crea la
       petición redirigida <var class="filename">http://mi.servidor/cgi-bin/php/directorio/secreto/script.php</var>.
       Desafortunadamente, si la petición es proporcionada originalmente en esta forma,
       no se revisan los accesos a los directorios hechos por el servidor web  <var class="filename">/directorio/secreto/script.php</var>, sino solamente al fichero
       <var class="filename">/cgi-bin/php</var>. De esta forma
       <var class="filename">/cgi-bin/php</var> cualquier usuario está habilitado a acceder
       a cualquier documento protegido en el servidor web.
      </span>
      <span class="simpara">
       En PHP, las directivas de configuración en tiempo de ejecución <a href="#ini.cgi.force-redirect" class="link">cgi.force_redirect</a>, <a href="#ini.doc-root" class="link">doc_root</a> y <a href="#ini.user-dir" class="link">user_dir</a> pueden ser utilizadas para prevenir
       este ataque, si el árbol de documentos del servidor tiene cualquiera de estos directorios
       con restricciones de acceso.  Véase más abajo para una explicación completa
       de las diferentes combinaciones.
      </span>
     </li>
    </ul>
   </div>
<hr>


   <div id="security.cgi-bin.default" class="sect1"><hr>
    <h2 class="title">Caso 1: Ficheros públicos servidos solamente</h2>

    <p class="simpara">
     Si su servidor no tiene ningún contenido que no esté restringido
     por contraseña o control de acceso basado en IP, no hay necesidad de
     estas opciones de configuración.  Si su servidor web no le permite
     hacer redirecciones, o el servidor no tiene una forma de
     comunicar al binario de PHP que la petición es una forma segura de
     petición de redireccionada la solicitud, puedes habilitar la directiva ini <a href="#ini.cgi.force-redirect" class="link">cgi.force_redirect</a>.  Usted todavía tiene que asegurarse que sus
     scripts de PHP no confían en una forma o en otra para llamar el script,
     ni directamente <var class="filename">http://my.host/cgi-bin/php/dir/script.php</var>
     ni por redirección <var class="filename">http://my.host/dir/script.php</var>.
    </p>
    <p class="simpara">
     La redirección puede ser configurada en Apache utilizando directivas
     <code class="literal">Action</code> y <code class="literal">AddHandler</code> (vea más abajo).
    </p>
   </div>
<hr>


   <div id="security.cgi-bin.force-redirect" class="sect1"><hr>
    <h2 class="title">Caso 2: utilizando <code class="literal">cgi.force_redirect</code></h2>
    <p class="simpara">
     La directiva de configuración <a href="#ini.cgi.force-redirect" class="link">cgi.force_redirect</a>
     previene a cualquiera que llame a PHP
     directamente por medio de una URL como esta <var class="filename">http://mi.servidor/cgi-bin/php/directoriosecreto/script.php</var>.
     En cambio, <strong class="command">php</strong> solamente lo analizará en este modo si éste se ha ido a través de
     una regla directa del servidor web.
    </p>
    <p class="simpara">
     Usualmente la redirección en la configuración de Apache se hace con
     las siguientes directivas:
    </p>
    <div class="example-contents">
<div class="apache-confcode"><pre class="apache-confcode">Action php-script /cgi-bin/php
AddHandler php-script .php</pre>
</div>
    </div>

    <p class="simpara">
     Esta opción ha sido probada solamente con el servidor web Apache, y
     se basa en que en Apache se configure en una variable de entorno no-estándar de CGI
     <var class="envar">REDIRECT_STATUS</var> para peticiones de redirección. Si su
     servidor web no soporta ninguna forma de decirle si la petición es
     directa o redirigida, usted no puede utilizar esta opción y debe usar
     una de las otras formas de ejecutar la versión CGI aquí documentadas.
    </p>
   </div>
<hr>


   <div id="security.cgi-bin.doc-root" class="sect1"><hr>
    <h2 class="title">Caso 3: Configurando doc_root o user_dir</h2>
    <p class="simpara">
     Para incluir contenido activo, como scripts y ejecutables, en los
     directorios de documentos del servidor web es algunas veces considerado una práctica
     insegura. Si, por el hecho del algún error de configuración, los scripts
     no se ejecutan y son mostrados como documentos HTML regulares, esto
     podría resultar en una fuga de información de propiedad intelectual
     o de información de seguridad como las contraseñas. Por lo tanto muchos Administradores de Sistemas
     preferirán configurar otra estructura de directorios para scripts que sean
     accesibles solamente a través del CGI de PHP, y por lo tanto siempre interpretado y no desplegado como tal.
    </p>
    <p class="simpara">
     También si el método para asegurar las peticiones no es
     redirigido, como se describió en la sección anterior, no está
     disponible, es necesario configurar un script doc_root que sea
     diferente de la raíz del documento web.
    </p>
    <p class="simpara">
     Usted puede configurar el script de la raíz de documento de PHP en la directiva
     de configuración <a href="#ini.doc-root" class="link">doc_root</a> en el
     <a href="#configuration.file" class="link">fichero de configuración</a>, o
     puede configurar la variable de entorno <var class="envar">PHP_DOCUMENT_ROOT</var>.
     Si éste es configurado, la versión del <abbr title="Common Gateway Interface">CGI</abbr>
     de PHP siempre construirá el nombre del fichero para abrir con este
     <code class="parameter">doc_root</code> y la ruta de información en la petición,
     de tal forma que pueda estar seguro que ningún script será ejecutado fuera de
     este directorio (excepto por <code class="parameter">user_dir</code> que se encuentra
     más abajo).
    </p>
    <p class="simpara">
     Otra opción utilizable es esta <a href="#ini.user-dir" class="link">user_dir</a>. Cuando user_dir no está configurado,
     lo único que controla el fichero abierto es <code class="parameter">doc_root</code>.
     Al abrir una URL como <var class="filename">http://mi.servidor/~usuario/documento.php</var> no resulta
     en la apertura de un fichero bajo el directorio personal de los usuarios, pero si
     un fichero llamado <var class="filename">~usuario/documento.php</var> debajo de
     doc_root (si, un nombre de directorio que inicia con una a tilde [<code class="literal">~</code>]).
    </p>
    <p class="simpara">
     Si <code class="parameter">user_dir</code> es configurado, por ejemplo <var class="filename">public_php</var>, una petición como <var class="filename">http://mi.servidor/~usuario/doc.php</var> abrirá un
     fichero llamado <var class="filename">doc.php</var> bajo el directorio
     llamado <var class="filename">public_php</var> debajo de el directorio
     personal del usuario.  Si el directorio personal del usuario es <var class="filename">/home/usuario</var>, el fichero ejecutado será
     <var class="filename">/home/user/public_php/doc.php</var>.
    </p>
    <p class="simpara">
     La expansión de <code class="parameter">user_dir</code> sucede sin tomar en cuenta
     la configuración de <code class="parameter">doc_root</code>, así que usted puede
     controlar el acceso a la raíz de los documentos y el directorio de los
     usuarios separadamente.
    </p>
   </div>
<hr>


   <div id="security.cgi-bin.shell" class="sect1"><hr>
    <h2 class="title">Caso 4: El analizador de PHP fuera del árbol de la web</h2>
    <p class="para">
     Una opción muy segura es poner el binario analizador de PHP en algún lugar
     fuera del árbol de ficheros de la web. En <var class="filename">/usr/local/bin</var>, por ejemplo.  El único inconveniente
     real con esta opción es que ahora tendrá que poner una línea similar a:
     </p><div class="informalexample">
      <div class="example-contents">
<div class="cdata"><pre>
#!/usr/local/bin/php
</pre></div>
      </div>

     </div>
     como la primera línea de cualquier fichero que contenga etiquetas de PHP. También
     necesitará hacer que el fichero sea ejecutable. Eso significa, tratarlo exactamente
     como trataría cualquier otro script de CGI escrito en Perl, sh, bash, o cualquier
     otro lenguaje común de script el cual utilice <code class="literal">#!</code> como mecanismo
     de ejecución de si mismo.
    
    <p class="para">
     Para que PHP maneje la información correctamente de <var class="envar">PATH_INFO</var> y
     <var class="envar">PATH_TRANSLATED</var> con esta configuración, La directiva ini <a href="#ini.cgi.discard-path" class="link">cgi.discard_path</a> debe estar habilitada..
    </p>
   </div>
<hr>


  </div>

<hr>




  



  <div id="security.apache" class="chapter"><hr>
   <h1 class="title">Instalado como módulo de Apache</h1>

   <p class="simpara">
    Cuando <abbr title="PHP: Hypertext Preprocessor">PHP</abbr> es usado como un módulo de Apache, hereda los
    permisos del usuario de Apache (generalmente los del usuario
    "nobody"). Este hecho representa varios impactos sobre la
    seguridad y las autorizaciones. Por ejemplo, si se está usando
    <abbr title="PHP: Hypertext Preprocessor">PHP</abbr> para acceder a una base de datos, a menos que tal base de
    datos disponga de un control de acceso propio, se tendrá
    que hacer que la base de datos sea asequible por el usuario
    "nobody".  Esto quiere decir que un script malicioso podría
    tener acceso y modificar la base de datos, incluso sin un nombre
    de usuario y contraseña. Es completamente posible que una
    araña web (bot) pudiera toparse con la página web de administración de
    una base de datos, y eliminar todo de la base de datos. Una
    protección ante este tipo de situaciones es mediante el uso del
    mecanismo de autorización de Apache, o con modelos de acceso
    de diseño propio usando LDAP, archivos <var class="filename">.htaccess</var>, etc. e
    incluir ese código como parte de los scripts <abbr title="PHP: Hypertext Preprocessor">PHP</abbr>.
   </p>
   <p class="simpara">
    Con frecuencia, una vez la seguridad se ha establecido en un punto
    en donde el usuario de <abbr title="PHP: Hypertext Preprocessor">PHP</abbr> (en este caso, el usuario de apache)
    tiene asociada muy poco riesgo, se descubre que
    <abbr title="PHP: Hypertext Preprocessor">PHP</abbr> se encuentra ahora imposibilitado de escribir archivos en los
    directorios de los usuarios. O quizás se le haya
    desprovisto de la capacidad de acceder o modificar bases de
    datos. Se ha prevenido  que pudiera escribir tanto
    archivos buenos como malos, o que pudiera realizar transacciones
    buenas o malas en la base de datos.
   </p>
   <p class="simpara">
    Un error de seguridad cometido con frecuencia en este punto es
    darle permisos de administrador (root) a apache, o incrementar las
    habilidades del usuario de apache de alguna otra forma.
   </p>
   <p class="simpara">
    Incrementar los permisos del usuario de Apache hasta el nivel de
    administrador es extremadamente peligroso y puede comprometer al
    sistema entero, así que el uso de entornos sudo, chroot, o
    cualquier otro mecanismo que sea ejecutado como root no
    debería ser considerado como una opción por aquellos que no
    son profesionales en seguridad.
   </p>
   <p class="simpara">
    Existen otras soluciones más simples. Mediante el uso
    de <a href="#ini.open-basedir" class="link">open_basedir</a> se
    puede controlar y restringir qué directorios
    pueden ser usados por <abbr title="PHP: Hypertext Preprocessor">PHP</abbr>. También se pueden definir
    áreas solo-Apache, para restringir todas las actividades
    basadas en web a archivos que no son de usuarios o del sistema.
   </p>
  </div>

<hr>




  




 <div id="security.sessions" class="chapter"><hr>
  <h1 class="title">Seguridad de una Sesión</h1>


  <p class="para">
   Es importante mantener seguro el manejo de sesión HTTP. La seguridad
   relacionada a la Sesión está descrita en
   <a href="#session.security" class="link">Seguridad de Sesión</a> en la sección
   de referencia <a href="#book.session" class="link">Módulo de Sesión</a>.
  </p>

 </div>

<hr>




  




  <div id="security.filesystem" class="chapter"><hr>
   <h1 class="title">Seguridad del Sistema de Archivos</h1>
<h2>Tabla de contenidos</h2><ul class="chunklist chunklist_chapter"><li><a href="#security.filesystem.nullbytes">Cuestiones relacionadas a bytes nulos</a></li></ul>

   <p class="simpara">
    <abbr title="PHP: Hypertext Preprocessor">PHP</abbr> está sujeto a la seguridad integrada en la mayoría de sistemas de servidores con
    respecto a los permisos de archivos y directorios. Esto permite
    controlar qué archivos en el sistema de archivos se pueden leer. Se debe
    tener cuidado con los archivos que son legibles para garantizar
    que son seguros para la lectura por todos los usuarios que tienen acceso al
    sistema de archivos.
   </p>
   <p class="simpara">
    Desde que <abbr title="PHP: Hypertext Preprocessor">PHP</abbr> fue diseñado para permitir el acceso a nivel de usuarios para el sistema de archivos,
    es perfectamente posible escribir un script <abbr title="PHP: Hypertext Preprocessor">PHP</abbr> que le permita
    leer archivos del sistema como <var class="filename">/etc/passwd</var>, modificar sus conexiones de red,
    enviar trabajos de impresión masiva, etc. Esto tiene algunas
    implicaciones obvias, es necesario asegurarse que los archivos
    que se van a leer o escribir son los apropiados.
   </p>
   <p class="simpara">
    Considere el siguiente script, donde un usuario indica que
    quiere borrar un archivo en su directorio home. Esto supone una
    situación en la que una interfaz web en <abbr title="PHP: Hypertext Preprocessor">PHP</abbr> es usada regularmente para gestionar archivos,
    por lo que es necesario que el usuario Apache pueda borrar archivos en los
    directorios home de los usuarios.
   </p>
   <p class="para">
    </p><div class="example" id="example-518">
     <p><strong>Ejemplo #1 Un control pobre puede llevar a ....</strong></p>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br><br></span><span style="color: #FF8000">// eliminar un archivo del directorio personal del usuario<br></span><span style="color: #0000BB">$username </span><span style="color: #007700">= </span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">'user_submitted_name'</span><span style="color: #007700">];<br></span><span style="color: #0000BB">$userfile </span><span style="color: #007700">= </span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">'user_submitted_filename'</span><span style="color: #007700">];<br></span><span style="color: #0000BB">$homedir  </span><span style="color: #007700">= </span><span style="color: #DD0000">"/home/</span><span style="color: #0000BB">$username</span><span style="color: #DD0000">"</span><span style="color: #007700">;<br><br></span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$homedir</span><span style="color: #DD0000">/</span><span style="color: #0000BB">$userfile</span><span style="color: #DD0000">"</span><span style="color: #007700">);<br><br>echo </span><span style="color: #DD0000">"El archivo ha sido eliminado!"</span><span style="color: #007700">;<br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
     </div>

    </div>
   Dado que el nombre de usuario y el nombre del archivo son enviados desde un formulario,
   estos pueden representar un nombre de archivo y un nombre de usuario que pertenecen a otra persona,
   incluso se podría borrar el archivo a pesar que se supone que no estaría permitido hacerlo.
   En este caso, usted desearía usar algún otro tipo de autenticación.
   Considere lo que podría suceder si las variables enviadas son
   <code class="literal">"../etc/"</code> y <code class="literal">"passwd"</code>. El código entonces se ejecutaría efectivamente como:
    <div class="example" id="example-519">
     <p><strong>Ejemplo #2 ... Un ataque al sistema de archivos</strong></p>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br><br></span><span style="color: #FF8000">// elimina un archivo desde cualquier lugar en el disco duro al que<br>// el usuario de PHP tiene acceso. Si PHP tiene acceso de root:<br></span><span style="color: #0000BB">$username </span><span style="color: #007700">= </span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">'user_submitted_name'</span><span style="color: #007700">]; </span><span style="color: #FF8000">// "../etc"<br></span><span style="color: #0000BB">$userfile </span><span style="color: #007700">= </span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">'user_submitted_filename'</span><span style="color: #007700">]; </span><span style="color: #FF8000">// "passwd"<br></span><span style="color: #0000BB">$homedir  </span><span style="color: #007700">= </span><span style="color: #DD0000">"/home/</span><span style="color: #0000BB">$username</span><span style="color: #DD0000">"</span><span style="color: #007700">; </span><span style="color: #FF8000">// "/home/../etc"<br><br></span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$homedir</span><span style="color: #DD0000">/</span><span style="color: #0000BB">$userfile</span><span style="color: #DD0000">"</span><span style="color: #007700">); </span><span style="color: #FF8000">// "/home/../etc/passwd"<br><br></span><span style="color: #007700">echo </span><span style="color: #DD0000">"El archivo ha sido eliminado!"</span><span style="color: #007700">;<br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
     </div>

    </div>
    Hay dos medidas importantes que usted debe tomar para prevenir estas
     cuestiones.
    <ul class="itemizedlist">
     <li class="listitem">
      <span class="simpara">
       Únicamente permisos limitados al usuario web de <abbr title="PHP: Hypertext Preprocessor">PHP</abbr>.
      </span>
     </li>
     <li class="listitem">
      <span class="simpara">
       Revise todas las variables que se envían.
      </span>
     </li>
    </ul>
    Aquí está una versión mejorada del script:
    <div class="example" id="example-520">
     <p><strong>Ejemplo #3 Comprobación más segura del nombre de archivo</strong></p>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br><br></span><span style="color: #FF8000">// elimina un archivo del disco duro al que<br>// el usuario de PHP tiene acceso.<br></span><span style="color: #0000BB">$username </span><span style="color: #007700">= </span><span style="color: #0000BB">$_SERVER</span><span style="color: #007700">[</span><span style="color: #DD0000">'REMOTE_USER'</span><span style="color: #007700">]; </span><span style="color: #FF8000">// usando un mecanismo de autenticación<br></span><span style="color: #0000BB">$userfile </span><span style="color: #007700">= </span><span style="color: #0000BB">basename</span><span style="color: #007700">(</span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">'user_submitted_filename'</span><span style="color: #007700">]);<br></span><span style="color: #0000BB">$homedir  </span><span style="color: #007700">= </span><span style="color: #DD0000">"/home/</span><span style="color: #0000BB">$username</span><span style="color: #DD0000">"</span><span style="color: #007700">;<br><br></span><span style="color: #0000BB">$filepath </span><span style="color: #007700">= </span><span style="color: #DD0000">"</span><span style="color: #0000BB">$homedir</span><span style="color: #DD0000">/</span><span style="color: #0000BB">$userfile</span><span style="color: #DD0000">"</span><span style="color: #007700">;<br><br>if (</span><span style="color: #0000BB">file_exists</span><span style="color: #007700">(</span><span style="color: #0000BB">$filepath</span><span style="color: #007700">) &amp;&amp; </span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #0000BB">$filepath</span><span style="color: #007700">)) {<br>    </span><span style="color: #0000BB">$logstring </span><span style="color: #007700">= </span><span style="color: #DD0000">"Se ha eliminado </span><span style="color: #0000BB">$filepath</span><span style="color: #DD0000">\n"</span><span style="color: #007700">;<br>} else {<br>    </span><span style="color: #0000BB">$logstring </span><span style="color: #007700">= </span><span style="color: #DD0000">"No se ha podido eliminar </span><span style="color: #0000BB">$filepath</span><span style="color: #DD0000">\n"</span><span style="color: #007700">;<br>}<br><br></span><span style="color: #0000BB">$fp </span><span style="color: #007700">= </span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">"/home/logging/filedelete.log"</span><span style="color: #007700">, </span><span style="color: #DD0000">"a"</span><span style="color: #007700">);<br></span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">, </span><span style="color: #0000BB">$logstring</span><span style="color: #007700">);<br></span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br><br>echo </span><span style="color: #0000BB">htmlentities</span><span style="color: #007700">(</span><span style="color: #0000BB">$logstring</span><span style="color: #007700">, </span><span style="color: #0000BB">ENT_QUOTES</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
     </div>

    </div>
    Sin embargo, incluso esto no está exento de defectos. Si la autenticación
    del sistema permite a los usuarios crear sus propios inicios de sesión de usuario, y un usuario
    eligió la entrada <code class="literal">"../etc/"</code>, el sistema está expuesto una vez más. Por
    esta razón, puede que prefiera escribir un chequeo más personalizado:
    <div class="example" id="example-521">
     <p><strong>Ejemplo #4 Comprobación más segura del nombre de archivo</strong></p>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br><br>$username     </span><span style="color: #007700">= </span><span style="color: #0000BB">$_SERVER</span><span style="color: #007700">[</span><span style="color: #DD0000">'REMOTE_USER'</span><span style="color: #007700">]; </span><span style="color: #FF8000">// usando un mecanismo de autenticación<br></span><span style="color: #0000BB">$userfile     </span><span style="color: #007700">= </span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">'user_submitted_filename'</span><span style="color: #007700">];<br></span><span style="color: #0000BB">$homedir      </span><span style="color: #007700">= </span><span style="color: #DD0000">"/home/</span><span style="color: #0000BB">$username</span><span style="color: #DD0000">"</span><span style="color: #007700">;<br><br></span><span style="color: #0000BB">$filepath     </span><span style="color: #007700">= </span><span style="color: #DD0000">"</span><span style="color: #0000BB">$homedir</span><span style="color: #DD0000">/</span><span style="color: #0000BB">$userfile</span><span style="color: #DD0000">"</span><span style="color: #007700">;<br><br>if (!</span><span style="color: #0000BB">ctype_alnum</span><span style="color: #007700">(</span><span style="color: #0000BB">$username</span><span style="color: #007700">) || !</span><span style="color: #0000BB">preg_match</span><span style="color: #007700">(</span><span style="color: #DD0000">'/^(?:[a-z0-9_-]|\.(?!\.))+$/iD'</span><span style="color: #007700">, </span><span style="color: #0000BB">$userfile</span><span style="color: #007700">)) {<br>    die(</span><span style="color: #DD0000">"nombre de usuario o nombre de archivo incorrecto"</span><span style="color: #007700">);<br>}<br><br></span><span style="color: #FF8000">// etc.<br><br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
     </div>

    </div>
   
   <p class="para">
    Dependiendo de sus sistema operativo, hay una gran variedad de archivos
    a los que debe estar atento, esto incluye las entradas de dispositivos (<var class="filename">/dev/</var>
    o <var class="filename">COM1</var>), archivos de configuracion (archivos <var class="filename">/etc/</var> y archivos <code class="literal">.ini</code>),
    las muy conocidas carpetas de almacenamiento (<var class="filename">/home/</var>, <var class="filename">My Documents</var>), etc. Por esta
    razón, por lo general es más fácil crear una política en donde se prohíba
    todo excepto lo que expresamente se permite.
   </p>
   <div id="security.filesystem.nullbytes" class="sect1"><hr>
    <h2 class="title">Cuestiones relacionadas a bytes nulos</h2>
    <p class="simpara">
     Como <abbr title="PHP: Hypertext Preprocessor">PHP</abbr> utiliza las funciones de C para operaciones relacionadas al sistema de archivos,
     se podría manejar bytes nulos de manera bastante inesperada.
     Como un byte nulo denota el fin de una cadena en C, las cadenas que contengan estos
     no serán consideradas por completo, sino sólo hasta que ocurra un byte nulo.

     El siguiente ejemplo muestra un código vulnerable que presenta este problema:
    </p>
    <div class="example" id="example-522">
     <p><strong>Ejemplo #1 Script vulnerable a bytes nulos</strong></p>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br><br>$file </span><span style="color: #007700">= </span><span style="color: #0000BB">$_GET</span><span style="color: #007700">[</span><span style="color: #DD0000">'file'</span><span style="color: #007700">]; </span><span style="color: #FF8000">// "../../etc/passwd\0"<br></span><span style="color: #007700">if (</span><span style="color: #0000BB">file_exists</span><span style="color: #007700">(</span><span style="color: #DD0000">'/home/wwwrun/' </span><span style="color: #007700">. </span><span style="color: #0000BB">$file </span><span style="color: #007700">. </span><span style="color: #DD0000">'.php'</span><span style="color: #007700">)) {<br>    </span><span style="color: #FF8000">// file_exists devolverá true si el archivo /home/wwwrun/../../etc/passwd existe<br>    </span><span style="color: #007700">include </span><span style="color: #DD0000">'/home/wwwrun/' </span><span style="color: #007700">. </span><span style="color: #0000BB">$file </span><span style="color: #007700">. </span><span style="color: #DD0000">'.php'</span><span style="color: #007700">;<br>    </span><span style="color: #FF8000">// el archivo /etc/passwd se incluirá<br></span><span style="color: #007700">}<br><br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
     </div>

    </div>
    <p class="para">
     Por lo tanto, cualquier cadena que se utiliza en una operación de sistema de archivos siembre deben
     ser validados correctamente. He aquí una versión mejorada del ejemplo anterior:
    </p>
    <div class="example" id="example-523">
     <p><strong>Ejemplo #2 Validando correctamente la entrada</strong></p>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br><br>$file </span><span style="color: #007700">= </span><span style="color: #0000BB">$_GET</span><span style="color: #007700">[</span><span style="color: #DD0000">'file'</span><span style="color: #007700">];<br><br></span><span style="color: #FF8000">// Lista blanca de valores posibles<br></span><span style="color: #007700">switch (</span><span style="color: #0000BB">$file</span><span style="color: #007700">) {<br>    case </span><span style="color: #DD0000">'main'</span><span style="color: #007700">:<br>    case </span><span style="color: #DD0000">'foo'</span><span style="color: #007700">:<br>    case </span><span style="color: #DD0000">'bar'</span><span style="color: #007700">:<br>        include </span><span style="color: #DD0000">'/home/wwwrun/include/'</span><span style="color: #007700">.</span><span style="color: #0000BB">$file</span><span style="color: #007700">.</span><span style="color: #DD0000">'.php'</span><span style="color: #007700">;<br>        break;<br>    default:<br>        include </span><span style="color: #DD0000">'/home/wwwrun/include/main.php'</span><span style="color: #007700">;<br>}<br><br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
     </div>

    </div>
   </div>
<hr>


  </div>

<hr>




  



<div id="security.database" class="chapter"><hr>
 <h1 class="title">Seguridad en bases de datos</h1>
<h2>Tabla de contenidos</h2><ul class="chunklist chunklist_chapter"><li><a href="#security.database.design">Diseño de bases de datos</a></li><li><a href="#security.database.connection">Conexión a una base de datos</a></li><li><a href="#security.database.storage">Modelo de almacenamiento cifrado</a></li><li><a href="#security.database.sql-injection">Inyección de SQL</a></li></ul>


 <p class="simpara">
  Hoy en día, las bases de datos son componentes esenciales de cualquier aplicación web,
  permitiendo a los sitios web proveer variedad de contenido dinámico. Puesto que se puede
  almacenar información muy delicada o secreta en una base de datos, debería considerarse
  ampliamente proteger las bases de datos.
 </p>
 <p class="simpara">
  Para obtener o almacenar cualquier información, es necesario conectarse a la base de datos,
  enviar una consulta válida, obtener el resultado, y cerrar la conexión.
  Hoy en día, el lenguaje de consultas más utilizado en esta interacción es el
  Lenguaje Estructurado de Consultas (SQL, por sus siglas en inglés). Vea como un atacante puede <a href="#security.database.sql-injection" class="link">realizar manipulaciones maliciosas con una consulta SQL</a>.
 </p>
 <p class="simpara">
  Como es de suponer, <abbr title="PHP: Hypertext Preprocessor">PHP</abbr> no puede proteger una base de datos por sí mismo. Las
  siguientes secciones tienen como objetivo ser una introducción básica de cómo
  acceder y manipular bases de datos dentro de scripts de <abbr title="PHP: Hypertext Preprocessor">PHP</abbr>.
 </p>
 <p class="simpara">
  Tenga en mente esta sencilla regla: Protección en profundidad. En cuantos más sitios se
  tomen acciones para aumentar la protección de una base de datos, menor es la
  probabilidad de que un atacante tenga éxito en exponer o abusar de cualquier información
  que tenga almacenada. Un buen diseño del esquema de la base de datos y de la aplicación
  se ocupará de sus mayores temores.
 </p>

 <div id="security.database.design" class="sect1"><hr>
  <h2 class="title">Diseño de bases de datos</h2>
  <p class="simpara">
   El primer paso es siempre crear una base de datos, a menos que se quiera utilizar
   una de un tercero. Cuando se crea una base de datos, esta es
   asignada a un propietario, aquel que ejecutó la sentencia de creación. Usualmente, sólo
   el propietario (o un superusuario) puede hacer cualquier cosa con los objetos de esa
   base de datos. Para que otros usuarios puedan utilizarla, se les deben conceder
   privilegios.
  </p>
  <p class="simpara">
   Las aplicaciones nunca deberían conectarse a la base de datos como su propietario o como
   un superusuario, porque estos usuarios pueden ejecutar cualquier consulta a su antojo; por
   ejemplo, modificar el esquema (p.ej., eliminar tablas) o borrar su contenido
   por completo.
  </p>
  <p class="simpara">
   Se pueden crear distintos usuarios de una base de datos para cada aspecto de la
   aplicación con permisos muy limitados a los objetos de dicha base de datos. Solamente
   deberían otorgarse los privilegios necesarios, evitando así que el mismo usuario
   pueda interactuar con la base de datos en diferentes casos y uso. Esto significa que si
   un intruso obtiene acceso a una base de datos utilizando las credenciales de la aplicación,
   solamente puede efectuar los cambios que la aplicación permita.
  </p>
 </div>
<hr>


 <div id="security.database.connection" class="sect1"><hr>
  <h2 class="title">Conexión a una base de datos</h2>
  <p class="simpara">
   Se pueden establecer las conexiones sobre SSL para cifrar
   las comunicaciones cliente/servidor y aumentar la seguridad, o también emplear ssh
   para cifrar la conexión de red entre los clientes y el servidor de bases de datos.
   Si se utiliza algunas de estas opciones, será difícil para un posible atacante
   la monitorización del tráfico y la obtención de información de la base de datos.
  </p>
  
 </div>
<hr>


 <div id="security.database.storage" class="sect1"><hr>
  <h2 class="title">Modelo de almacenamiento cifrado</h2>
  <p class="simpara">
   SSL/SSH protege los datos que viajan desde el cliente al servidor: SSL/SSH
   no protege los datos persistentes almacenados en una base de datos. SSL es un
   protocolo que protege los datos mientras viajan por el cable.
  </p>
  <p class="simpara">
   Una vez que un atacante obtiene acceso directo a una base de datos (eludiendo el
   servidor web), los datos sensibles almacenados podrían ser divulgados o mal utilizados, a menos que
   la información esté protegida por la base de datos misma. Cifrar los datos
   es una buena forma de mitigar esta amenaza, pero muy pocas bases de datos ofrecen este
   tipo de cifrado de datos.
  </p>
  <p class="simpara">
   La forma más sencilla para evitar este problema es crear primero un paquete de
   cifrado propio y utilizarlo en los scripts de <abbr title="PHP: Hypertext Preprocessor">PHP</abbr>. Hay muchas
   extensiones de <abbr title="PHP: Hypertext Preprocessor">PHP</abbr> que pueden ser de ayuda para esto, tales como <a href="#book.openssl" class="link">OpenSSL</a> y <a href="#book.sodium" class="link">Sodium</a>, cubriendo así una amplia variedad de algoritmos de
   cifrado. El script cifra los datos antes de insertarlos en la base de datos, y los
   descifra al obtenerlos. Véanse las referencias para ejemplos adicionales del
   funcionamiento del cifrado.
  </p>

  <div class="sect2" id="security.database.storage.hashing">
   <h3 class="title">'Hashing'</h3>
   <p class="simpara">
    En caso de datos que deban estar realmente ocultos, si no fuera necesaria su representación real,
    (es decir, que no sean mostrados), quizás convenga utilizar algoritmos hash.
    El ejemplo más típico del uso del hash es a la hora de almacenar el hash criptográfico de una
    contraseña en una base de datos, en lugar de almacenar la contraseña en sí.
   </p>
   <p class="simpara">
    Las funciones de <a href="#ref.password" class="link">password</a>
    proporcionan una forma adecuada de utilizar hash con datos delicados y trabajar con estos hash.
   </p>
   <p class="simpara">
    <span class="function"><a href="#function.password-hash" class="function">password_hash()</a></span> se emplea para usar un hash con una cadena dada utilizando
    el algoritmo más fuerte actualmente disponible, mientras que <span class="function"><a href="#function.password-verify" class="function">password_verify()</a></span>
    comprueba si la contraseña dada coincide con el hash almacenado en la base de datos.
   </p>
   <div class="example" id="example-524">
    <p><strong>Ejemplo #1 Campo de contraseña con hash</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br><br></span><span style="color: #FF8000">// Almacenar el hash de la contraseña<br></span><span style="color: #0000BB">$query  </span><span style="color: #007700">= </span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">"INSERT INTO users(name,pwd) VALUES('%s','%s');"</span><span style="color: #007700">,<br>            </span><span style="color: #0000BB">pg_escape_string</span><span style="color: #007700">(</span><span style="color: #0000BB">$nombre_usuario</span><span style="color: #007700">),<br>            </span><span style="color: #0000BB">password_hash</span><span style="color: #007700">(</span><span style="color: #0000BB">$password</span><span style="color: #007700">, </span><span style="color: #0000BB">PASSWORD_DEFAULT</span><span style="color: #007700">));<br></span><span style="color: #0000BB">$result </span><span style="color: #007700">= </span><span style="color: #0000BB">pg_query</span><span style="color: #007700">(</span><span style="color: #0000BB">$connection</span><span style="color: #007700">, </span><span style="color: #0000BB">$query</span><span style="color: #007700">);<br><br></span><span style="color: #FF8000">// Consultar si el usuario envió la contraseña correcta<br></span><span style="color: #0000BB">$query </span><span style="color: #007700">= </span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT pwd FROM users WHERE name='%s';"</span><span style="color: #007700">,<br>                </span><span style="color: #0000BB">pg_escape_string</span><span style="color: #007700">(</span><span style="color: #0000BB">$nombre_usuario</span><span style="color: #007700">));<br></span><span style="color: #0000BB">$row </span><span style="color: #007700">= </span><span style="color: #0000BB">pg_fetch_assoc</span><span style="color: #007700">(</span><span style="color: #0000BB">pg_query</span><span style="color: #007700">(</span><span style="color: #0000BB">$connection</span><span style="color: #007700">, </span><span style="color: #0000BB">$query</span><span style="color: #007700">));<br><br>if (</span><span style="color: #0000BB">$row </span><span style="color: #007700">&amp;&amp; </span><span style="color: #0000BB">password_verify</span><span style="color: #007700">(</span><span style="color: #0000BB">$contraseña</span><span style="color: #007700">, </span><span style="color: #0000BB">$row</span><span style="color: #007700">[</span><span style="color: #DD0000">'pwd'</span><span style="color: #007700">])) {<br>    echo </span><span style="color: #DD0000">'Bienvenido, ' </span><span style="color: #007700">. </span><span style="color: #0000BB">htmlspecialchars</span><span style="color: #007700">(</span><span style="color: #0000BB">$username</span><span style="color: #007700">) . </span><span style="color: #DD0000">'!'</span><span style="color: #007700">;<br>} else {<br>    echo </span><span style="color: #DD0000">'La autenticación ha fallado para ' </span><span style="color: #007700">. </span><span style="color: #0000BB">htmlspecialchars</span><span style="color: #007700">(</span><span style="color: #0000BB">$username</span><span style="color: #007700">) . </span><span style="color: #DD0000">'.'</span><span style="color: #007700">;<br>}<br><br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
    </div>

   </div>
  </div>
 </div>
<hr>


 <div id="security.database.sql-injection" class="sect1"><hr>
  <h2 class="title">Inyección de SQL</h2>
  <p class="simpara">
   La inyección SQL es una técnica en la que un atacante aprovecha fallas en el código de la aplicación encargado de construir consultas SQL dinámicas. El atacante puede obtener acceso a secciones privilegiadas de la aplicación, recuperar toda la información de la base de datos, manipular datos existentes o incluso ejecutar comandos peligrosos a nivel del sistema en el host de la base de datos. La vulnerabilidad ocurre cuando los desarrolladores concatenan o interpolan entrada arbitraria en sus declaraciones SQL.
  </p>
  <p class="para">
   </p><div class="example" id="example-525">
    <p><strong>Ejemplo #1 
     Dividir el conjunto de resultados en páginas ... y crear superusuarios
     (PostgreSQL)
    </strong></p>
    <div class="example-contents"><p>
     En el siguiente ejemplo, la entrada del usuario se interpola directamente en la consulta SQL, lo que permite al atacante obtener una cuenta de superusuario en la base de datos.
    </p></div>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br><br>$offset </span><span style="color: #007700">= </span><span style="color: #0000BB">$_GET</span><span style="color: #007700">[</span><span style="color: #DD0000">'offset'</span><span style="color: #007700">]; </span><span style="color: #FF8000">// ¡Cuidado, no hay validación en la entrada de datos!<br></span><span style="color: #0000BB">$query  </span><span style="color: #007700">= </span><span style="color: #DD0000">"SELECT id, name FROM products ORDER BY name LIMIT 20 OFFSET </span><span style="color: #0000BB">$offset</span><span style="color: #DD0000">;"</span><span style="color: #007700">;<br></span><span style="color: #0000BB">$result </span><span style="color: #007700">= </span><span style="color: #0000BB">pg_query</span><span style="color: #007700">(</span><span style="color: #0000BB">$conn</span><span style="color: #007700">, </span><span style="color: #0000BB">$query</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
    </div>

   </div>
   Un usuario común hace clic en los enlaces 'siguiente' o 'atrás' donde el <var class="varname">$índice</var>
   está codificado en el <abbr title="Uniform Resource Locator">URL</abbr>. El script espera que el <var class="varname">$índice</var>
   entrante sea un número. Sin embargo, Qué sucede si alguien intenta ingresar al añadir lo siguiente a la <abbr title="Uniform Resource Locator">URL</abbr>?
   <div class="informalexample">
    <div class="example-contents">
<div class="sqlcode"><pre class="sqlcode">0;
insert into pg_shadow(usename,usesysid,usesuper,usecatupd,passwd)
    select 'crack', usesysid, 't','t','crack'
    from pg_shadow where usename='postgres';
--</pre>
</div>
    </div>

   </div>
   Si ocurriera, el script presentaría un acceso de superusuario al atacante.
   Observe que <code class="literal">0;</code> es para proveer un índcie válido a la
   consulta original y así finalizarla.
  
  <blockquote class="note"><p><strong class="note">Nota</strong>: 
   </p><p class="para">
    Es una técnica común forzar al analizador SQL a ignorar el resto de la
    consulta escrita por el desarrollador con <code class="literal">--</code>, lo cual
    representa un comentario en SQL.
   </p>
  </blockquote>
  <p class="para">
   Una forma factible de obtener contraseñas es burlar las páginas de búsqueda de resultados.
   Lo único que el atacante necesita hacer es ver si hay variables que hayan sido enviadas
   y sean empleadas en sentencias SQL que no sean manejadas apropiadamente. Estos filtros se pueden establecer
   comunmente en un formulario anterior para personalizar las cláusulas <code class="literal">WHERE, ORDER BY,
   LIMIT</code> y <code class="literal">OFFSET</code> en las sentencias <code class="literal">SELECT</code>.
   Si la base de datos admite el constructor <code class="literal">UNION</code>,
   el atacante podría intentar anteponer una consulta entera a la consulta original para enumerar las
   contraseñas de una tabla arbitraria. Se recomienda encarecidamente almacenar solo hashes seguros de contraseñas en lugar de las contraseñas mismas.
   </p><div class="example" id="example-526">
    <p><strong>Ejemplo #2 
     Enumerar artículos ... y algunas contraseñas (cualquier servidor de bases de datos)
    </strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br><br>$query  </span><span style="color: #007700">= </span><span style="color: #DD0000">"SELECT id, name, inserted, size FROM products<br>           WHERE size = '</span><span style="color: #0000BB">$size</span><span style="color: #DD0000">'"</span><span style="color: #007700">;<br></span><span style="color: #0000BB">$result </span><span style="color: #007700">= </span><span style="color: #0000BB">odbc_exec</span><span style="color: #007700">(</span><span style="color: #0000BB">$conexión</span><span style="color: #007700">, </span><span style="color: #0000BB">$query</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
    </div>

   </div>
   La parte estática de la consulta se puede combinar con otra sentencia
   <code class="literal">SELECT</code> la cual revelará todas las contraseñas:
   <div class="informalexample">
    <div class="example-contents">
<div class="sqlcode"><pre class="sqlcode">'
union select '1', concat(uname||'-'||passwd) as name, '1971-01-01', '0' from usertable;
--</pre>
</div>
    </div>

   </div>
  
  <p class="para">
   Las declaraciones <code class="literal">UPDATE</code> e <code class="literal">INSERT</code> también son susceptibles a este tipo de ataques.
   </p><div class="example" id="example-527">
    <p><strong>Ejemplo #3 
     Desde restablecer una contraseña ... hasta obtener más privilegios (cualquier servidor de bases de datos)
    </strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br>$query </span><span style="color: #007700">= </span><span style="color: #DD0000">"UPDATE usertable SET pwd='</span><span style="color: #0000BB">$pwd</span><span style="color: #DD0000">' WHERE uid='</span><span style="color: #0000BB">$uid</span><span style="color: #DD0000">';"</span><span style="color: #007700">;<br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
    </div>

   </div>
   Si un usuario malicioso podría enviar el valor
   <code class="literal">' or uid like'%admin%</code> a <var class="varname">$uid</var> para
   cambiar la contraseña del administrador, o simplemente cambiar <var class="varname">$pwd</var> a
   <code class="literal">jejeje', trusted=100, admin='yes</code> para obtener más
   privilegios, entonces la consulta se tornaría:
   <div class="informalexample">
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br><br></span><span style="color: #FF8000">// $uid: ' or uid like '%admin%<br></span><span style="color: #0000BB">$query </span><span style="color: #007700">= </span><span style="color: #DD0000">"UPDATE usertable SET pwd='...' WHERE uid='' or uid like '%admin%';"</span><span style="color: #007700">;<br><br></span><span style="color: #FF8000">// $pwd: jejeje', trusted=100, admin='yes<br></span><span style="color: #0000BB">$query </span><span style="color: #007700">= </span><span style="color: #DD0000">"UPDATE usertable SET pwd='jejeje', trusted=100, admin='yes' WHERE<br>...;"</span><span style="color: #007700">;<br><br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
    </div>

   </div>
  
  <p class="simpara">
   Aunque sigue siendo evidente que un atacante debe poseer al menos cierto conocimiento de la arquitectura de la base de datos para llevar a cabo un ataque exitoso, obtener esta información a menudo es muy simple. Por ejemplo, el código puede ser parte de un software de código abierto y estar disponible públicamente. Esta información también puede ser revelada por código fuente cerrado, incluso si está codificado, ofuscado o compilado, e incluso por tu propio código a través de la visualización de mensajes de error. Otros métodos incluyen el uso de nombres de tablas y columnas típicos. Por ejemplo, un formulario de inicio de sesión que utiliza una tabla 'users' con nombres de columnas 'id', 'username' y 'password'.
  </p>
  <p class="para">
   </p><div class="example" id="example-528">
    <p><strong>Ejemplo #4 Atacar el sistema operativo del host de la base de datos (MSSQL Server)</strong></p>
    <div class="example-contents"><p>
     Un ejemplo alarmante de cómo los comandos a nivel del sistema operativo pueden ser accedidos en algunos hosts de bases de datos.
    </p></div>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br><br>$query  </span><span style="color: #007700">= </span><span style="color: #DD0000">"SELECT * FROM products WHERE id LIKE '%</span><span style="color: #0000BB">$prod</span><span style="color: #DD0000">%'"</span><span style="color: #007700">;<br></span><span style="color: #0000BB">$result </span><span style="color: #007700">= </span><span style="color: #0000BB">mssql_query</span><span style="color: #007700">(</span><span style="color: #0000BB">$query</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
    </div>

   </div>
   Si un atacante envía el valor
   <code class="literal">a%' exec master..xp_cmdshell 'net user test testpass /ADD' --</code>
   a <var class="varname">$prod</var>, la <var class="varname">$query</var> será:
   <div class="informalexample">
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br><br>$query  </span><span style="color: #007700">= </span><span style="color: #DD0000">"SELECT * FROM products<br>              WHERE id LIKE '%a%'<br>              exec master..xp_cmdshell 'net user test testpass /ADD' --%'"</span><span style="color: #007700">;<br></span><span style="color: #0000BB">$result </span><span style="color: #007700">= </span><span style="color: #0000BB">mssql_query</span><span style="color: #007700">(</span><span style="color: #0000BB">$query</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
    </div>

   </div>
   El servidor MSSQL ejecuta la sentencia SQL en el lote incluyendo un comando
   para añadir un usuario nuevo a la base de datos de cuentas local. Si esta aplicación
   estaban siendo ejecutados como <code class="literal">sa</code> y el servicio MSSQLSERVER estaba
   ejecutando con los privilegios suficientes, el atacante ahora podría tener una cuenta
   con la cual acceder a esta máquina.
  
  <blockquote class="note"><p><strong class="note">Nota</strong>: 
   </p><p class="para">
    Algunos ejemplos anteriores están vinculados a un servidor de bases de datos específico, pero esto no significa que un ataque similar sea imposible contra otros productos. Tu servidor de bases de datos puede ser igualmente vulnerable de otra manera.
   </p>
  </blockquote>
  <p class="para">
   </p><div class="mediaobject">
    
    <div class="imageobject">
     <img src="php-bigxhtml-data/images/fa7c5b5f326e3c4a6cc9db19e7edbaf0-xkcd-bobby-tables.png" alt="Un ejemplo divertido de los problemas relacionados con la inyección SQL." width="666" height="205">
    </div>
    <div class="caption">
     <p class="simpara">
      Imagen cortesía de <a href="http://xkcd.com/327" class="link external">» xkcd</a>
     </p>
    </div>
   </div>
  

  <div class="sect2" id="security.database.avoiding">
   <h3 class="title">Técnicas de evitación</h3>
   <p class="para">
    La forma recomendada de evitar la inyección SQL es vincular todos los datos mediante declaraciones preparadas. Utilizar consultas parametrizadas no es suficiente para evitar por completo la inyección SQL, pero es la manera más fácil y segura de proporcionar datos a las declaraciones SQL. Todas las literales de datos dinámicos en las cláusulas <code class="literal">WHERE</code>, <code class="literal">SET</code>, y <code class="literal">VALUES</code> deben ser reemplazadas con marcadores de posición. Los datos reales se vincularán durante la ejecución y se enviarán por separado del comando SQL.
   </p>
   <p class="para">
    La vinculación de parámetros solo puede utilizarse para datos. Otras partes dinámicas de la consulta SQL deben filtrarse contra una lista conocida de valores permitidos.
   </p>
   <p class="para">
    </p><div class="example" id="example-529">
     <p><strong>Ejemplo #5 Evitar la inyección SQL mediante el uso de declaraciones preparadas con PDO</strong></p>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br><br></span><span style="color: #FF8000">// La parte dinámica del SQL se valida contra valores esperados<br></span><span style="color: #0000BB">$sortingOrder </span><span style="color: #007700">= </span><span style="color: #0000BB">$_GET</span><span style="color: #007700">[</span><span style="color: #DD0000">'sortingOrder'</span><span style="color: #007700">] === </span><span style="color: #DD0000">'DESC' </span><span style="color: #007700">? </span><span style="color: #DD0000">'DESC' </span><span style="color: #007700">: </span><span style="color: #DD0000">'ASC'</span><span style="color: #007700">;<br></span><span style="color: #0000BB">$productId </span><span style="color: #007700">= </span><span style="color: #0000BB">$_GET</span><span style="color: #007700">[</span><span style="color: #DD0000">'productId'</span><span style="color: #007700">];<br></span><span style="color: #FF8000">// El SQL se prepara con un marcador de posición<br></span><span style="color: #0000BB">$stmt </span><span style="color: #007700">= </span><span style="color: #0000BB">$pdo</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">prepare</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT * FROM products WHERE id LIKE ? ORDER BY price </span><span style="color: #007700">{</span><span style="color: #0000BB">$sortingOrder</span><span style="color: #007700">}</span><span style="color: #DD0000">"</span><span style="color: #007700">);<br></span><span style="color: #FF8000">// El valor se proporciona con comodines LIKE<br></span><span style="color: #0000BB">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">([</span><span style="color: #DD0000">"%</span><span style="color: #007700">{</span><span style="color: #0000BB">$productId</span><span style="color: #007700">}</span><span style="color: #DD0000">%"</span><span style="color: #007700">]);<br><br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
   </div>

</div>

<p class="simpara">
 Las declaraciones preparadas son proporcionadas por <a href="#pdo.prepared-statements" class="link">PDO</a>, <a href="#mysqli.quickstart.prepared-statements" class="link">MySQLi</a> y otras bibliotecas de bases de datos.
</p>

<p class="simpara">
 Los ataques de inyección SQL se basan principalmente en explotar código que no ha sido escrito teniendo en cuenta la seguridad. Nunca confíes en ninguna entrada, especialmente desde el lado del cliente, incluso si proviene de un cuadro de selección, un campo de entrada oculto o una cookie. El primer ejemplo muestra que una consulta tan simple puede causar desastres.
</p>

<p class="para">
 Una estrategia de defensa en profundidad implica varias buenas prácticas de codificación:
 </p><ul class="itemizedlist">
  <li class="listitem">
   <span class="simpara">
    Nunca te conectes a la base de datos como un superusuario o como el propietario de la base de datos. Utiliza siempre usuarios personalizados con privilegios mínimos.
   </span>
  </li>
  <li class="listitem">
   <span class="simpara">
    Verifica si la entrada proporcionada tiene el tipo de datos esperado. <abbr title="PHP: Hypertext Preprocessor">PHP</abbr> tiene una amplia gama de funciones de validación de entrada, desde las más simples encontradas en <a href="#ref.var" class="link">Funciones de Variables</a> y en <a href="#ref.ctype" class="link">Funciones de Tipo de Carácter</a> (por ejemplo, <span class="function"><a href="#function.is-numeric" class="function">is_numeric()</a></span>, <span class="function"><a href="#function.ctype-digit" class="function">ctype_digit()</a></span> respectivamente) hasta el soporte de <a href="#ref.pcre" class="link">Expresiones Regulares Compatibles con Perl</a>.
   </span>
  </li>
  <li class="listitem">
   <span class="simpara">
    Si la aplicación espera una entrada numérica, considera verificar los datos con <span class="function"><a href="#function.ctype-digit" class="function">ctype_digit()</a></span>, cambiar silenciosamente su tipo usando <span class="function"><a href="#function.settype" class="function">settype()</a></span>, o usar su representación numérica con <span class="function"><a href="#function.sprintf" class="function">sprintf()</a></span>.
   </span>
  </li>
  <li class="listitem">
   <span class="simpara">
    Si la capa de la base de datos no admite la vinculación de variables, entonces coloca comillas alrededor de cada valor proporcionado por el usuario que no sea numérico y que se pase a la base de datos con la función de escape de cadena específica de la base de datos (por ejemplo, <span class="function"><a href="#function.mysql-real-escape-string" class="function">mysql_real_escape_string()</a></span>, <span class="function"><strong>sqlite_escape_string()</strong></span>, etc.). Las funciones genéricas como <span class="function"><a href="#function.addslashes" class="function">addslashes()</a></span> son útiles solo en un entorno muy específico (por ejemplo, MySQL en un conjunto de caracteres de un solo byte con <var class="varname">NO_BACKSLASH_ESCAPES</var> deshabilitado), así que es mejor evitarlas.
   </span>
  </li>
  <li class="listitem">
   <span class="simpara">
    No imprimas ninguna información específica de la base de datos, especialmente sobre el esquema, por las buenas o por las malas. Consulta también <a href="#security.errors" class="link">Informes de Errores</a> y <a href="#ref.errorfunc" class="link">Funciones de Manejo y Registro de Errores</a>.
   </span>
  </li>
 </ul>

<p class="simpara">
    Además, se puede beneficiar del registro de consultas, ya sea dentro de un script
    o mediante la base de datos en sí misma, si es que lo soporta. Obviamente, llevar un registro no
    previene los intentos dañinos, aunque puede ser útil para realizar un seguimiento de las
    aplicación que han sido eludidas. El registro no es útil por sí mismo sino
    por la información que contiene. Normalmente cuantos más detalles, mejor.
   </p>
  </div>
 </div>
<hr>

</div>

<hr>




  




  <div id="security.errors" class="chapter"><hr>
   <h1 class="title">Reportando errores</h1>

   <p class="para">
    Con la seguridad de PHP, hay dos formas para reportar errores. Una es
    en beneficio, para incrementar la seguridad, y la otra es para perjudicar.
   </p>
   <p class="para">
    Una táctica estándar de ataque conlleva a perfilar un sistema; llenándolo
    de datos incorrectos, revisando los tipos y contextos de los errores
    que son devueltos. Esto le permite al atacante recolectar información
    acerca del servidor, para determinar posibles debilidades.
    Por ejemplo, si un atacante ha recogido información sobre una página
    basada en un envío previo, él podría intentar sobrescribir las variables,
    o modificarlas:
    </p><div class="example" id="example-530">
     <p><strong>Ejemplo #1 Atacando variables con una página HTML personalizada</strong></p>
     <div class="example-contents">
<div class="htmlcode"><pre class="htmlcode">&lt;form method="post" action="objetivodelataque?username=badfoo&amp;amp;password=badfoo"&gt;
&lt;input type="hidden" name="username" value="badfoo" /&gt;
&lt;input type="hidden" name="password" value="badfoo" /&gt;
&lt;/form&gt;</pre>
</div>
     </div>

    </div>
   
   <p class="para">
    Los errores de PHP que normalmente son devueltos, pueden ser muy útiles para
    el desarrollador que está intentando depurar un script, indicando qué cosas,
    como por ejemplo, qué función o qué fichero de PHP falló, y el número de línea en donde
    la falla ocurrió. Toda esta es la información que puede ser explotada.
    Esto no es algo raro para un desarrollador de PHP que utilice las funciones
    <span class="function"><a href="#function.show-source" class="function">show_source()</a></span>, <span class="function"><a href="#function.highlight-string" class="function">highlight_string()</a></span>, o
    <span class="function"><a href="#function.highlight-file" class="function">highlight_file()</a></span> como una medida de depuración, pero en
    un sitio en escena, esto puede exponer variables ocultas, sintáxis sin revisar,
    y otra información peligrosa. Es especialmente peligroso el código en ejecución
    de fuentes conocidas con manejadores de depuración incluidos, o utilizar
    técnicas comunes de depuración. Si los atacantes pueden determinar qué técnica en
    general usted está utilizando, ellos podrían tratar de usar fuerza bruta en una página,
    enviando varias cadenas comunes de depuración:
    </p><div class="example" id="example-531">
     <p><strong>Ejemplo #2 Explotando variables comunes de depuración</strong></p>
     <div class="example-contents">
<div class="htmlcode"><pre class="htmlcode">&lt;form method="post" action="objetivodelataque?errors=Y&amp;amp;showerrors=1&amp;amp;debug=1"&gt;
&lt;input type="hidden" name="errors" value="Y" /&gt;
&lt;input type="hidden" name="showerrors" value="1" /&gt;
&lt;input type="hidden" name="debug" value="1" /&gt;
&lt;/form&gt;</pre>
</div>
     </div>

    </div>
   
   <p class="para">
    Sin importar el método de manejo de errores, la capacidad de probar
    errores en un sistema conlleva a proveer a un atacante con mas
    información.
   </p>
   <p class="para">
    Por ejemplo, el estilo común de un error genérico de PHP indica que un sistema
    ciertamente está ejecutando PHP. Si un atacante está en una página <code class="literal">.html</code>, y quiere
    probar qué motor hay tras de ese servidor (para buscar debilidades en el sistema),
    lo alimenta con datos erróneos que lo podrían habilitar a que determine
    que ese sistema fue construido con PHP.
   </p>
   <p class="para">
    El error de una función puede indicar ya sea, un sistema que puede estar
    ejecutando un motor específico de base de datos, o dar las pistas de cómo una página web
    puede estar programada o diseñada. Esto permite una investigación más profunda dentro
    de los puertos abiertos de la base de datos, o buscar errores específicos o debilidades
    en una página web. Pasando diferentes porciones de datos erróneos, por ejemplo,
    un atacante puede determinar el orden de autenticación en un script,
    (por medio del número de línea de los errores) como también probar exploits
    que pueden ser utilizados en diferentes ubicaciones del script.
   </p>
   <p class="para">
    Un error del sistema de archivos o un error general de PHP puede indicar qué permisos
    tiene el servidor web, así también la estructura y organización de
    ficheros en el servidor web. El código de error escrito por el desarrollador puede agravar
    este problema, conllevando a la explotación fácil de la, hasta entonces,
    información "oculta".
   </p>
   <p class="para">
    Hay tres grandes soluciones a este problema. La primera consiste en
    examinar todas las funciones, e intentar arreglar la mayoría
    de los errores. La segunda es deshabilitar completamente la notificación de errores
    de el código en ejecución. La tercera es utilizar las funciones de manejo de error
    propias de PHP para crear su propio manejador de errores. Dependiendo
    de su política de seguridad, puede ser que encuentre que las tres sean aplicables
    a su situación.
   </p>
   <p class="para">
    Una forma de detectar este problema por adelantado es hacer uso de
    la función propia de PHP <span class="function"><a href="#function.error-reporting" class="function">error_reporting()</a></span>, para ayudarle a
    asegurar su código y encontrar el uso de variables que podrían ser peligrosas.
    Al probar su código, antes de distribuirlo, con <strong><code><a href="#constant.e-all">E_ALL</a></code></strong>,
    usted puede encontrar rapidamente áreas donde sus variables pueden ser abiertas para envenenamiento
    o modificación en otras maneras. Una vez usted está listo para distribuirlo,
    debería deshabilitar completamente el reporte de errores poniendo el valor de
    <span class="function"><a href="#function.error-reporting" class="function">error_reporting()</a></span> a 0, o apagar el visor de errores
    utilizando la  opción <code class="literal">display_errors</code> del fichero <var class="filename">php.ini</var>
    para aislar su código de ataques. Si decide hacer esto último,
    también debería definir la ruta de acceso a su archivo de registros utilizando
    la directiva <code class="literal">error_log</code>, y poner
    <code class="literal">log_errors</code> en "on".
    </p><div class="example" id="example-532">
     <p><strong>Ejemplo #3 Buscando variables peligrosas con E_ALL</strong></p>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br></span><span style="color: #007700">if (</span><span style="color: #0000BB">$username</span><span style="color: #007700">) {  </span><span style="color: #FF8000">// No se ha inicializado o revisado antes de utilizar<br>    </span><span style="color: #0000BB">$good_login </span><span style="color: #007700">= </span><span style="color: #0000BB">1</span><span style="color: #007700">;<br>}<br>if (</span><span style="color: #0000BB">$good_login </span><span style="color: #007700">== </span><span style="color: #0000BB">1</span><span style="color: #007700">) { </span><span style="color: #FF8000">// Si la prueba anterior falla, los que no estén inicializados o comprobados antes de utilizar, tendrán acceso<br>    </span><span style="color: #0000BB">readfile</span><span style="color: #007700">(</span><span style="color: #DD0000">"/ruta/hacia/datos/altamente/sensibles/index.html"</span><span style="color: #007700">);<br>}<br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
     </div>

    </div>
   
  </div>

<hr>




  




<div id="security.variables" class="chapter"><hr>
 <h1 class="title">Datos Enviados por el Usuario</h1>

 <p class="para">
  Las mayores debilidades de muchos programas <abbr title="PHP: Hypertext Preprocessor">PHP</abbr> no son inherentes al
  lenguaje mismo, sino simplemente un problema generado cuando se escribe
  código sin pensar en la seguridad. Por esta razón, usted debería tomarse
  siempre el tiempo para considerar las implicaciones de cada pedazo de
  código, para averiguar el posible peligro involucrado cuando una variable
  inesperada es enviada.
  </p><div class="example" id="example-533">
   <p><strong>Ejemplo #1 Uso Peligroso de Variables</strong></p>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br></span><span style="color: #FF8000">// eliminar un archivo del directorio personal del usuario .. ¿o<br>// quizás de alguien más?<br><br></span><span style="color: #0000BB">unlink </span><span style="color: #007700">(</span><span style="color: #0000BB">$evil_var</span><span style="color: #007700">);<br><br></span><span style="color: #FF8000">// Imprimir el registro del acceso... ¿o quizás una entrada de /etc/passwd?<br></span><span style="color: #0000BB">fwrite </span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">, </span><span style="color: #0000BB">$evil_var</span><span style="color: #007700">);<br><br></span><span style="color: #FF8000">// Ejecutar algo trivial.. ¿o rm -rf *?<br></span><span style="color: #0000BB">system </span><span style="color: #007700">(</span><span style="color: #0000BB">$evil_var</span><span style="color: #007700">);<br></span><span style="color: #0000BB">exec </span><span style="color: #007700">(</span><span style="color: #0000BB">$evil_var</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">?&gt;</span></span></code></div>
   </div>

  </div>
 
 <p class="para">
  Usted debería examinar siempre, y cuidadosamente su código para asegurarse
  de que cualquier variable siendo enviada desde un navegador web sea
  chequeada apropiadamente, y preguntarse a sí mismo:
  </p><ul class="itemizedlist">
   <li class="listitem">
    <span class="simpara">
     ¿Este script afectará únicamente los archivos que se pretende?
    </span>
   </li>
   <li class="listitem">
    <span class="simpara">
     ¿Puede tomarse acción sobre datos inusuales o indeseados?
    </span>
   </li>
   <li class="listitem">
    <span class="simpara">
     ¿Puede ser usado este script en formas malintencionadas?
    </span>
   </li>
   <li class="listitem">
    <span class="simpara">
     ¿Puede ser usado en conjunto con otros scripts en forma negativa?
    </span>
   </li>
   <li class="listitem">
    <span class="simpara">
     ¿Serán adecuadamente registradas las transacciones?
    </span>
   </li>
  </ul>
 
 <p class="para">
  Al preguntarse adecuadamente estas preguntas mientras escribe su script,
  en lugar de hacerlo posteriormente, usted previene una desafortunada
  re-implementación del programa cuando desee incrementar el nivel de
  seguridad. Al comenzar con esta mentalidad, no garantizará la seguridad de
  su sistema, pero puede ayudar a mejorarla.
 </p>
 <p class="para">
  Mejore la seguridad deshabilitando las configuraciones de conveniencia que
  oscurecen el origen, la validez o la integridad de los datos de entrada.
  La creación implícita de variables y la entrada no verificada pueden llevar a
  vulnerabilidades como ataques de inyección y manipulación de datos.
 </p>
 <p class="para">
  Características como <code class="literal">register_globals</code> y
  <code class="literal">magic_quotes</code> (ambas eliminadas en PHP 5.4.0) contribuyeron
  a estos riesgos al crear automáticamente variables a partir de la entrada del
  usuario y escapar datos de manera inconsistente. Aunque ya no están en PHP,
  riesgos similares persisten si la gestión de la entrada es incorrecta.
 </p>
 <p class="para">
  Habilite <a href="#function.error-reporting" class="link">error_reporting(E_ALL)</a> para
  ayudar a detectar variables no inicializadas y validar la entrada. Utilice
  tipos estrictos (<a href="#language.types.declarations.strict" class="link">declare(strict_types=1)</a>,
  introducido en PHP 7) para imponer la seguridad de tipos, prevenir conversiones
  de tipos no intencionadas y mejorar la seguridad general.
 </p>
</div>

<hr>




  




<div id="security.hiding" class="chapter"><hr>
 <h1 class="title">Ocultar PHP</h1>

 <p class="para">
  En general, la seguridad por ocultación es una de las formas más débiles de seguridad.
  Aunque en algunos casos, es aconsejable cada pequeño elemento extra de seguridad.
 </p>
 <p class="para">
  Unas cuantas técnicas simples pueden ayudar a ocultar <abbr title="PHP: Hypertext Preprocessor">PHP</abbr>, posiblemente retrasando
  a un atacante que esté tratando de descubrir debilidades en el
  sistema. Al establecer expose_php a <code class="literal">off</code> en el
  fichero <var class="filename">php.ini</var>, se reduce la cantidad de información disponible.
 </p>
 <p class="para">
  Otra táctica es configurar servidores web como Apache para
  interpretar diferentes tipos de ficheros por medio de <abbr title="PHP: Hypertext Preprocessor">PHP</abbr>, ya sea con una directiva
  de <var class="filename">.htaccess</var> o en el propio fichero de configuración de Apache. Así se pueden
  utilizar extensiones de ficheros engañosas:
  </p><div class="example" id="example-534">
   <p><strong>Ejemplo #1 Ocultando PHP como si fuera otro lenguaje</strong></p>
   <div class="example-contents">
<div class="apache-confcode"><pre class="apache-confcode"># Hacer que el código de PHP parezca otro tipo de código
AddType application/x-httpd-php .asp .py .pl</pre>
</div>
   </div>

  </div>
  U ocultarlo completamente:
  <div class="example" id="example-535">
   <p><strong>Ejemplo #2 Utilizar tipos desconocidos para extensiones de PHP</strong></p>
   <div class="example-contents">
<div class="apache-confcode"><pre class="apache-confcode"># Hacer que el código de PHP parezca de tipo desconocido
AddType application/x-httpd-php .bop .foo .133t</pre>
</div>
   </div>

  </div>
  U ocultarlo como código <abbr title="Hyper Text Markup Language">HTML</abbr>, lo cual tiene un pequeño impacto de rendimiento debido
  a que todos los ficheros <abbr title="Hyper Text Markup Language">HTML</abbr> serán procesados por el motor de <abbr title="PHP: Hypertext Preprocessor">PHP</abbr>:
  <div class="example" id="example-536">
   <p><strong>Ejemplo #3 Utilizar tipos <abbr title="Hyper Text Markup Language">HTML</abbr> para extensiones de PHP</strong></p>
   <div class="example-contents">
<div class="apache-confcode"><pre class="apache-confcode"># Hacer que el código de PHP parezca HTML
AddType application/x-httpd-php .htm .html</pre>
</div>
   </div>

  </div>
  Para que esto funcione eficazmente, se debe cambiar el nombre de los ficheros <abbr title="PHP: Hypertext Preprocessor">PHP</abbr> con
  las extensiones de arriba. Si bien es una forma de seguridad por
  ocultamiento, es una medida preventiva menor con pocos inconvenientes.
 
</div>

<hr>





  




<div id="security.current" class="chapter"><hr>
 <h1 class="title">Mantenerse al día</h1>

 <p class="simpara">
  PHP, como cualquier otro sistema de tamaño considerable, está bajo constante escrutinio
  y mejoramiento. Cada nueva versión incluye con frecuencia cambios mayores y
  menores para mejorar la seguridad y reparar cualquier fallo, problemas de
  configuración, y otros asuntos que puedan afectar la seguridad y estabilidad
  global del sistema.
 </p>
 <p class="simpara">
  Como cualquier lenguaje y programa de script a nivel de sistema, la mejor
  estrategia es actualizar con frecuencia y mantenerse alerta sobre las últimas
  versiones y sus cambios.
 </p>
</div>

<hr>




 <ul class="chunklist chunklist_book"><li><a href="#security.intro">Introducción</a></li><li><a href="#security.general">Consideraciones generales</a></li><li><a href="#security.cgi-bin">Instalado como CGI binario</a><ul class="chunklist chunklist_book chunklist_children"><li><a href="#security.cgi-bin.attacks">Ataques posibles</a></li><li><a href="#security.cgi-bin.default">Caso 1: Ficheros públicos servidos solamente</a></li><li><a href="#security.cgi-bin.force-redirect">Caso 2: utilizando cgi.force_redirect</a></li><li><a href="#security.cgi-bin.doc-root">Caso 3: Configurando doc_root o user_dir</a></li><li><a href="#security.cgi-bin.shell">Caso 4: El analizador de PHP fuera del árbol de la web</a></li></ul></li><li><a href="#security.apache">Instalado como módulo de Apache</a></li><li><a href="#security.sessions">Seguridad de una Sesión</a></li><li><a href="#security.filesystem">Seguridad del Sistema de Archivos</a><ul class="chunklist chunklist_book chunklist_children"><li><a href="#security.filesystem.nullbytes">Cuestiones relacionadas a bytes nulos</a></li></ul></li><li><a href="#security.database">Seguridad en bases de datos</a><ul class="chunklist chunklist_book chunklist_children"><li><a href="#security.database.design">Diseño de bases de datos</a></li><li><a href="#security.database.connection">Conexión a una base de datos</a></li><li><a href="#security.database.storage">Modelo de almacenamiento cifrado</a></li><li><a href="#security.database.sql-injection">Inyección de SQL</a></li></ul></li><li><a href="#security.errors">Reportando errores</a></li><li><a href="#security.variables">Datos Enviados por el Usuario</a></li><li><a href="#security.hiding">Ocultar PHP</a></li><li><a href="#security.current">Mantenerse al día</a></li></ul></div>